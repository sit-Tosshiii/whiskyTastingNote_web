# Whisky Tasting Note システム設計図（将来像込みの概要）

## 1. 全体構成（ざっくり俯瞰）

- クライアント（ブラウザ / PWA）
  - Next.js (App Router) + TypeScript
  - スマホ利用を主軸とした UI
  - データ一次保管: IndexedDB（完全オフライン対応）
- ローカルデータ層
  - `lib/localNotes.ts` が IndexedDB をラップし、ノートの CRUD を提供
  - 画面 (`/notes`, `/notes/new`, `/tools/data` など) はこのモジュール経由でローカルデータを操作
- 将来のサーバー / クラウド（任意でオン）
  - Supabase (Postgres + Auth + Storage + Edge Functions)
  - 主な役割候補:
    - 共有用の公開ノートホスティング
    - 認証付きの「ユーザーごとのクラウドノート」
    - 重い分析処理のオフロード

イメージ図:

```text
[ユーザー端末のブラウザ / PWA]
  ├─ UI (Next.js pages/components)
  │    ├─ ノート一覧 / 編集 / 登録
  │    ├─ 分析画面（ローカル集計 or API）
  │    └─ 公開ノート閲覧ページ (/share/[slug])
  ├─ ローカル保存: IndexedDB
  │    └─ lib/localNotes.ts
  └─ (オンライン時) Supabase API
       ├─ Auth (ログイン)
       ├─ Postgres (tasting_notes, shared_notes)
       └─ 将来: 分析 API, ストレージ
```

## 2. データモデル

### 2-1. ローカル専用（IndexedDB / 既存）

- `NoteRecord` (IndexedDB)
  - フィールド例:
    - `id`
    - `whisky_name`
    - `distillery_name`
    - `region`
    - `aroma`
    - `flavor`
    - `summary`
    - `abv`
    - `cask`
    - `rating`
    - `drinking_method`
    - `images`
    - `created_at`
    - `updated_at`
  - 「ログイン不要・端末ごとの個人ノート」として完結している。

### 2-2. クラウド側（Supabase / 既存 + 将来）

- `profiles`（migrations で定義済み）
  - `id` = `auth.users.id` に紐づくプロフィール
  - ユーザー表示名や設定などを保持する想定。

- `tasting_notes`（ユーザーごとのノート）
  - 概ね `NoteRecord` と同じ構造 + `user_id`
  - RLS: `auth.uid() = user_id` のユーザーのみ参照・更新可能。

- `shared_notes`（公開用ノート）※将来追加を想定
  - 例:
    - `id`
    - `owner_id`
    - `slug`
    - `note` (jsonb, 公開用に整形したノート)
    - `is_public`
    - `published_at`
  - RLS:
    - `is_public = true` の行は anon（未ログイン）でも `select` 可能。
    - 作成・更新・削除は `auth.uid() = owner_id` のみ許可。

## 3. 主要ユースケースとフロー

### 3-1. ローカルでのノート管理（現状メイン）

- ユーザー操作:
  - `/notes/new` で入力 → `NoteForm` → `addNote()` → IndexedDB へ保存。
  - `/notes` で `getAllNotes()` を読み込み、クライアント内で検索・ソート。
  - `/tools/data` で JSON エクスポート / インポート（バックアップ・復元）。
- 特徴:
  - 完全オフラインで動作。
  - 端末ごとにデータが分かれる（クラウド同期なし）。

### 3-2. ノートの公開（将来機能）

- 前提:
  - ユーザー認証（Supabase Auth）により「誰のノートか」が分かる。

- フロー（想定）:
  1. ユーザーが `/notes` 一覧から「公開」ボタンを押す。
  2. モーダルで「公開する項目」を選ぶ（画像や細かいメモを外すことも可能）。
  3. クライアントが Supabase に対して
     - `shared_notes` に `slug` と公開用 JSON (`note`) を保存。
  4. 生成された URL（例: `https://app.example.com/share/abcd1234`）をコピー、または X で共有。
  5. 他のユーザーはログイン不要でその URL から公開ノートを閲覧。

### 3-3. ノートの分析・可視化

#### 第一段階（クライアントのみ）

- `getAllNotes()` の結果をブラウザ内で集計する:
  - スコア分布ヒストグラム。
  - 産地別件数。
  - 香り・味わいの頻出ワード。
- `/analytics` ページでグラフ表示（Recharts など）。
- すべてブラウザ内で完結するため、オフラインでも動作可能。

#### 発展段階（サーバー分析）

- Supabase 側の `tasting_notes` を API 経由で取得し、サーバー / Edge Functions で:
  - Word2Vec などのモデルを使った嗜好分析。
  - 類似ノート・レコメンドの算出。
- 結果だけをフロントに返し、クライアント側で可視化（UI は第一段階とほぼ共通）。

## 4. 認証の位置づけ

### 4-1. なぜ認証が必要か

- 公開機能やクラウド側の分析 / バックアップでは「誰のノートか」を明確にする必要がある。
- 端末が変わっても同じユーザーとして扱いたい場合に必須。

### 4-2. モードの想定

- ログイン不要モード（現在）
  - IndexedDB だけを使用。
  - 公開機能やクラウド分析は使わない、または匿名公開のみ検討。

- ログインありモード（将来）
  - Supabase Auth でログインを提供。
  - ログインユーザーに紐づいた `tasting_notes` / `shared_notes` を扱う。
  - ローカル IndexedDB は「オフラインキャッシュ」として扱う。
    - オンライン時にクラウドと同期する戦略も検討対象。

## 5. Next.js 内のレイヤー構造

- `app/`（ルーティング）
  - `/` ホーム
  - `/notes` 一覧・検索
  - `/notes/new` 登録
  - `/notes/[id]/edit` 編集
  - `/tools/data` バックアップ
  - `/analytics` 分析（将来追加）
  - `/share/[slug]` 公開ノート閲覧（将来追加）
  - `/auth/*` ログイン / ログアウト（将来追加）

- `components/`
  - `NoteForm`, `NotesList`, `ShareToX`
  - 分析用 UI: `analytics/*`（グラフなど、将来追加）

- `lib/`
  - `localNotes.ts`（IndexedDB アクセス）
  - `supabaseClient.ts`（Supabase クライアント初期化、将来追加）
  - `statistics.ts`（ノート集計ロジック、将来追加）
  - `tweetIntent.ts` などの補助モジュール。

## 6. 今後の設計上の論点

- ログインを「いつ導入するか」
  - 現状はログインなしで完結している。
  - ステップ案:
    1. ローカルのみの分析ページを先に実装。
    2. 匿名でもよいシンプルな公開機能を試す。
    3. 本格的な「クラウド保存 + 公開 + 高度分析」の段階で Supabase Auth を導入。

- データの「正」と「キャッシュ」をどちらに置くか
  - IndexedDB を正とするか、Postgres(Supabase) を正とするか。
  - 実運用上は:
    - 初期は IndexedDB が正。
    - 将来クラウド同期を入れるときに「同期戦略」を別途設計する二段階アプローチが現実的。

