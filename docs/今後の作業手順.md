# Whisky Tasting Note 今後の作業手順メモ

このファイルは、現時点の構想にもとづく「これから何をどの順番で進めるか」「クラウド側で何を用意するか」「Docker を使ったローカル開発がどうなりそうか」をざっくり整理したメモです。

---

## 1. 今後の作業順（ざっくりロードマップ）

「すぐ必要なもの → 将来拡張」の順で並べています。

### ① ローカル機能の仕上げ

- 既存のノート登録・検索・エクスポートまわりを軽く整える。
  - 入力バリデーションやプレースホルダ文言の調整。
  - 「分析で使いたい項目」が揃っているか確認（産地、スコア、香り/味わいテキストなど）。
- ここまでは完全に IndexedDB だけで完結する。

### ② ローカル分析ページの追加（クラウドなし）

- `getAllNotes()` を元にブラウザ内で簡単な集計を行う。
  - ノート件数、平均スコア。
  - 産地別の件数。
  - 香り/味わいの頻出キーワードなど。
- `/analytics` のようなページを作り、グラフや表で可視化する。
- すべてクライアント側で処理するため、オフラインでも動作可能。
- この段階ではまだクラウドも認証も不要。

### ③ クラウド基盤（Supabase）の準備

- Supabase プロジェクトを用意する（または後述の Supabase CLI + Docker でローカル環境を起動）。
- このリポジトリの `supabase/migrations` を使って DB スキーマを構築する。
  - `supabase db push` で `profiles` / `tasting_notes` などを作成。
  - RLS が有効になっていることを確認。
- Next.js 側の開発用 `.env.local` に以下を設定する。
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- ここまでで「アプリから Supabase/Postgres に接続できる土台」ができる。

### ④ 認証（ログイン）の導入

- Supabase Auth を使ってログイン機能を追加する。
  - メール + Magic Link、もしくは Google / Apple などの OAuth を選択。
- Next.js 側に、最小限の認証 UI を用意。
  - `/auth/signin` のようなサインインページ。
  - ヘッダーに「ログイン / ログアウト」ボタンと、ログイン中ユーザー名の表示。
- API ハンドラーやサーバーコンポーネントから `auth.uid()` に相当するユーザー ID を取得できる状態にする。
  - （技術的には Supabase の Auth Helpers を使う想定）
- この段階で「誰のノートか」をサーバー側で判定できるようになる。

### ⑤ ノート公開機能（シンプル版）

- 認証済みユーザーだけが「このノートを公開する」操作を行えるようにする。
- Supabase 側に `shared_notes` テーブル（新規）を作成し、RLS を設計。
  - 公開用 slug、公開するノート内容（json）、公開/非公開フラグなどを持たせるイメージ。
  - `is_public = true` のものは匿名ユーザーでも閲覧可、それ以外は owner のみ操作可。
- Next.js 側のフロー（イメージ）:
  1. `/notes` の一覧から「公開」ボタンを押す。
  2. モーダルで「どの項目を公開するか」を選ぶ（画像や詳細メモを外すことも可能）。
  3. Supabase に `shared_notes` を作成/更新して slug を受け取る。
  4. 生成された URL（例: `/share/abcd1234`）をコピー or X で共有。
  5. 他ユーザーはログイン不要でその URL からノートを閲覧。

### ⑥ クラウド分析 / レコメンド（発展）

- Supabase 上の `tasting_notes` を使って、サーバー側で分析やレコメンドを行う。
  - 例: Word2Vec のようなモデルを使った類似ノート検索。
  - 例: スコアや香り傾向からのおすすめ提案。
- 分析 API を作り、Next.js からその API を呼んで結果を受け取る。
  - `/analytics` ページの UI を流用し、「ローカル版」「クラウド版」両方を選べる形も検討可能。
- この段階の開発には、API のレスポンス設計やスケーラビリティなどサーバーよりの検討が入ってくる。

---

## 2. クラウド側で準備すべきもの

### 2-1. まず必要になるもの

- バックエンドとしての中心は Supabase を想定している。
  - Postgres（DB）
  - Auth（ログイン機能）
  - Storage（必要であれば画像アップロードなど）
  - Edge Functions（高度な分析やバッチ処理が必要になった場合）

### 2-2. あとから考えればよいもの

- Next.js アプリのクラウドホスティング
  - 例: Vercel、Netlify、Railway など。
  - ローカル開発だけなら必須ではなく、「公開したくなったタイミング」で検討でよい。
- 監視・ログ・エラートラッキング
  - 例: Sentry など。
  - ある程度ユーザーが増えてからでも十分。
- 画像や大容量データのクラウド保存
  - 現状は IndexedDB に base64 で画像を入れているため、将来クラウドへ移す場合に Supabase Storage や S3 を検討する。

まとめると、現時点の設計では、**クラウド側で必須なのは Supabase（+ その中の Postgres/Auth）だけ**と考えて問題ない。

---

## 3. Docker を使ったローカル開発について

「クラウド相当の環境」を手元で再現する選択肢はいくつかある。

### パターンA: Supabase CLI + Docker（おすすめ）

- Supabase が公式に提供している CLI を利用する。
  - `supabase start`  
    → Docker 上で Supabase 一式（Postgres / Auth / ストレージなど）がローカル起動する。
  - `supabase db push`  
    → このリポジトリの `supabase/migrations` にある SQL がローカル Supabase に適用される。
- メリット:
  - 本番の Supabase とほぼ同じ構成をそのままローカルで再現できる。
  - RLS や Auth 周りも同じ挙動で試せる。
- このパターンを使う場合、アプリ側からは「クラウドの Supabase」と同じように接続すればよい。
  - `NEXT_PUBLIC_SUPABASE_URL` をローカルの Supabase URL に向けるだけで動くイメージ。

### パターンB: このリポジトリの `docker-compose.yml` を使う

- リポジトリ直下の `docker-compose.yml` と `database/` / `services/` を使って、自前の Postgres やサービス群を立てる方法。
- メリット:
  - Supabase に依存せず、自分で DB やサービスを設計できる。
- デメリット:
  - Supabase 特有の Auth や RLS を自前で再実装する必要が出てくる。
  - 「Supabase 前提の設計」で進める場合は、パターンAの方がシンプル。

### 結論（現状の設計に対して）

- 今の方針（Supabase をバックエンドに使う想定）であれば:
  - **Supabase CLI + Docker を使う開発フロー（パターンA）** がもっとも自然。
  - `supabase start` + `supabase db push` を行えば、クラウドと同じ DB・Auth 環境をローカルで再現できる。
- 将来、「完全に自前バックエンドに切り替える」ことを検討する場合は:
  - `docker-compose.yml` と `database/` / `services/` を用いて別設計を検討する余地はあるが、
  - 現段階ではそこまで準備しなくても十分。

---

このファイルはあくまで「現時点の考え」をメモしたものなので、実際に実装を進めながら、優先度や順番を入れ替えたり、不要になったステップを削る前提で使ってください。

